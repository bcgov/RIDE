# Stage 1: Build SPA
FROM node:24-alpine AS build

WORKDIR /app

COPY ./src/frontend/ /app/

ARG FONTAWESOME_PACKAGE_TOKEN

RUN npm ci
RUN npm install react-router-dom
RUN npm run build:vite

# Stage 2: Nginx runtime
FROM nginx:stable-alpine AS production

EXPOSE 3000

RUN touch /run/nginx.pid

# Copy built SPA into Nginx html folder
COPY --from=build /app/build/client /usr/share/nginx/html

# Copy custom nginx config
COPY ./compose/frontend/default.conf /etc/nginx/conf.d
RUN chmod -R 777 /run /var/log/nginx /var/cache/nginx /etc/nginx/conf.d /usr/share/nginx/html/assets

COPY ./compose/frontend/entrypoint /docker-entrypoint.d/add_client_env.sh
RUN sed -i 's/\r$//g' /docker-entrypoint.d/add_client_env.sh && chmod +x /docker-entrypoint.d/add_client_env.sh
