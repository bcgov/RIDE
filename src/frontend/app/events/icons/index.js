import incidentMajorActiveStatic from './majorincident-default-static.svg';
import incidentMajorActiveHover from './majorincident-default-hover.svg';
import incidentMajorActiveActive from './majorincident-default-active.svg';
import incidentMajorClearingStatic from './majorincident-clearing-static.svg';
import incidentMajorClearingHover from './majorincident-clearing-hover.svg';
import incidentMajorClearingActive from './majorincident-clearing-active.svg';
import incidentMajorInactiveStatic from './majorincident-inactive-static.svg';
import incidentMajorInactiveHover from './majorincident-inactive-hover.svg';
import incidentMajorInactiveActive from './majorincident-inactive-active.svg';

import incidentMajorClosureActiveStatic from './closure-default-static.svg';
import incidentMajorClosureActiveHover from './closure-default-hover.svg';
import incidentMajorClosureActiveActive from './closure-default-active.svg';
import incidentMajorClosureClearingStatic from './closure-clearing-static.svg';
import incidentMajorClosureClearingHover from './closure-clearing-hover.svg';
import incidentMajorClosureClearingActive from './closure-clearing-active.svg';
import incidentMajorClosureInactiveStatic from './closure-inactive-static.svg';
import incidentMajorClosureInactiveHover from './closure-inactive-hover.svg';
import incidentMajorClosureInactiveActive from './closure-inactive-active.svg';

import plannedMajorActiveStatic from './majordelay-default-static.svg';
import plannedMajorActiveHover from './majordelay-default-hover.svg';
import plannedMajorActiveActive from './majordelay-default-active.svg';
import plannedMajorClearingStatic from './majordelay-clearing-static.svg';
import plannedMajorClearingHover from './majordelay-clearing-hover.svg';
import plannedMajorClearingActive from './majordelay-clearing-active.svg';
import plannedMajorInactiveStatic from './majordelay-inactive-static.svg';
import plannedMajorInactiveHover from './majordelay-inactive-hover.svg';
import plannedMajorInactiveActive from './majordelay-inactive-active.svg';

import plannedMajorClosureActiveStatic from './closure-default-static.svg';
import plannedMajorClosureActiveHover from './closure-default-hover.svg';
import plannedMajorClosureActiveActive from './closure-default-active.svg';
import plannedMajorClosureClearingStatic from './closure-clearing-static.svg';
import plannedMajorClosureClearingHover from './closure-clearing-hover.svg';
import plannedMajorClosureClearingActive from './closure-clearing-active.svg';
import plannedMajorClosureInactiveStatic from './closure-inactive-static.svg';
import plannedMajorClosureInactiveHover from './closure-inactive-hover.svg';
import plannedMajorClosureInactiveActive from './closure-inactive-active.svg';

import plannedMajorFutureActiveStatic from './majorfuture-default-static.svg';
import plannedMajorFutureActiveHover from './majorfuture-default-hover.svg';
import plannedMajorFutureActiveActive from './majorfuture-default-active.svg';
import plannedMajorFutureClearingStatic from './majorfuture-clearing-static.svg';
import plannedMajorFutureClearingHover from './majorfuture-clearing-hover.svg';
import plannedMajorFutureClearingActive from './majorfuture-clearing-active.svg';
import plannedMajorFutureInactiveStatic from './majorfuture-inactive-static.svg';
import plannedMajorFutureInactiveHover from './majorfuture-inactive-hover.svg';
import plannedMajorFutureInactiveActive from './majorfuture-inactive-active.svg';

import plannedMajorFutureClosureActiveStatic from './majorfutureclosure-default-static.svg';
import plannedMajorFutureClosureActiveHover from './majorfutureclosure-default-hover.svg';
import plannedMajorFutureClosureActiveActive from './majorfutureclosure-default-active.svg';
import plannedMajorFutureClosureClearingStatic from './majorfutureclosure-clearing-static.svg';
import plannedMajorFutureClosureClearingHover from './majorfutureclosure-clearing-hover.svg';
import plannedMajorFutureClosureClearingActive from './majorfutureclosure-clearing-active.svg';
import plannedMajorFutureClosureInactiveStatic from './majorfutureclosure-inactive-static.svg';
import plannedMajorFutureClosureInactiveHover from './majorfutureclosure-inactive-hover.svg';
import plannedMajorFutureClosureInactiveActive from './majorfutureclosure-inactive-active.svg';

import incidentMinorActiveStatic from './minorincident-default-static.svg';
import incidentMinorActiveHover from './minorincident-default-hover.svg';
import incidentMinorActiveActive from './minorincident-default-active.svg';
import incidentMinorClearingStatic from './minorincident-clearing-static.svg';
import incidentMinorClearingHover from './minorincident-clearing-hover.svg';
import incidentMinorClearingActive from './minorincident-clearing-active.svg';
import incidentMinorInactiveStatic from './minorincident-inactive-static.svg';
import incidentMinorInactiveHover from './minorincident-inactive-hover.svg';
import incidentMinorInactiveActive from './minorincident-inactive-active.svg';

import incidentMinorClosureActiveStatic from './closure-default-static.svg';
import incidentMinorClosureActiveHover from './closure-default-hover.svg';
import incidentMinorClosureActiveActive from './closure-default-active.svg';
import incidentMinorClosureClearingStatic from './closure-clearing-static.svg';
import incidentMinorClosureClearingHover from './closure-clearing-hover.svg';
import incidentMinorClosureClearingActive from './closure-clearing-active.svg';
import incidentMinorClosureInactiveStatic from './closure-inactive-static.svg';
import incidentMinorClosureInactiveHover from './closure-inactive-hover.svg';
import incidentMinorClosureInactiveActive from './closure-inactive-active.svg';

import plannedMinorActiveStatic from './minordelay-default-static.svg';
import plannedMinorActiveHover from './minordelay-default-hover.svg';
import plannedMinorActiveActive from './minordelay-default-active.svg';
import plannedMinorClearingStatic from './minordelay-clearing-static.svg';
import plannedMinorClearingHover from './minordelay-clearing-hover.svg';
import plannedMinorClearingActive from './minordelay-clearing-active.svg';
import plannedMinorInactiveStatic from './minordelay-inactive-static.svg';
import plannedMinorInactiveHover from './minordelay-inactive-hover.svg';
import plannedMinorInactiveActive from './minordelay-inactive-active.svg';

import plannedMinorClosureActiveStatic from './closure-default-static.svg';
import plannedMinorClosureActiveHover from './closure-default-hover.svg';
import plannedMinorClosureActiveActive from './closure-default-active.svg';
import plannedMinorClosureClearingStatic from './closure-clearing-static.svg';
import plannedMinorClosureClearingHover from './closure-clearing-hover.svg';
import plannedMinorClosureClearingActive from './closure-clearing-active.svg';
import plannedMinorClosureInactiveStatic from './closure-inactive-static.svg';
import plannedMinorClosureInactiveHover from './closure-inactive-hover.svg';
import plannedMinorClosureInactiveActive from './closure-inactive-active.svg';

import plannedMinorFutureActiveStatic from './minorfuture-default-static.svg';
import plannedMinorFutureActiveHover from './minorfuture-default-hover.svg';
import plannedMinorFutureActiveActive from './minorfuture-default-active.svg';
import plannedMinorFutureClearingStatic from './minorfuture-clearing-static.svg';
import plannedMinorFutureClearingHover from './minorfuture-clearing-hover.svg';
import plannedMinorFutureClearingActive from './minorfuture-clearing-active.svg';
import plannedMinorFutureInactiveStatic from './minorfuture-inactive-static.svg';
import plannedMinorFutureInactiveHover from './minorfuture-inactive-hover.svg';
import plannedMinorFutureInactiveActive from './minorfuture-inactive-active.svg';

import plannedMinorFutureClosureActiveStatic from './minorfutureclosure-default-static.svg';
import plannedMinorFutureClosureActiveHover from './minorfutureclosure-default-hover.svg';
import plannedMinorFutureClosureActiveActive from './minorfutureclosure-default-active.svg';
import plannedMinorFutureClosureClearingStatic from './minorfutureclosure-clearing-static.svg';
import plannedMinorFutureClosureClearingHover from './minorfutureclosure-clearing-hover.svg';
import plannedMinorFutureClosureClearingActive from './minorfutureclosure-clearing-active.svg';
import plannedMinorFutureClosureInactiveStatic from './minorfutureclosure-inactive-static.svg';
import plannedMinorFutureClosureInactiveHover from './minorfutureclosure-inactive-hover.svg';
import plannedMinorFutureClosureInactiveActive from './minorfutureclosure-inactive-active.svg';

import chainupActiveStatic from './chainup-default-static.svg';
import chainupActiveHover from './chainup-default-hover.svg';
import chainupActiveActive from './chainup-default-active.svg';
import chainupClearingStatic from './chainup-clearing-static.svg';
import chainupClearingHover from './chainup-clearing-hover.svg';
import chainupClearingActive from './chainup-clearing-active.svg';
import chainupInactiveStatic from './chainup-inactive-static.svg';
import chainupInactiveHover from './chainup-inactive-hover.svg';
import chainupInactiveActive from './chainup-inactive-active.svg';

import roadconditionActiveStatic from './roadcondition-default-static.svg';
import roadconditionActiveHover from './roadcondition-default-hover.svg';
import roadconditionActiveActive from './roadcondition-default-active.svg';
import roadconditionClearingStatic from './roadcondition-clearing-static.svg';
import roadconditionClearingHover from './roadcondition-clearing-hover.svg';
import roadconditionClearingActive from './roadcondition-clearing-active.svg';
import roadconditionInactiveStatic from './roadcondition-inactive-static.svg';
import roadconditionInactiveHover from './roadcondition-inactive-hover.svg';
import roadconditionInactiveActive from './roadcondition-inactive-active.svg';

import chainup from './chainup.svg';
import closure from './closure.svg';
import majordelay from './majordelay.svg';
import majorfuture from './majorfuture.svg';
import majorfutureclosure from './majorfutureclosure.svg';
import majorincident from './majorincident.svg';
import minordelay from './minordelay.svg';
import minorfuture from './minorfuture.svg';
import minorfutureclosure from './minorfutureclosure.svg';
import MinorIncident from './minorincident.svg?react';
import roadcondition from './roadcondition.svg';

import './icons.scss';

/* The structure of icons is a hierarchy:
 *   {
 *     <type>:
 *       <severity>:
 *         <tense>:
 *           <closure>:
 *             <status>:
 *               <pointer state>
 *   }
 *
 * `type` matches the event type in the form submitted to create the event.
 *
 * `severity` matches event severity.
 *
 * `tense` is a relative value depending on whether the event has started at the
 * time the event is evaluated to get an icon.
 *
 * `closure` matches whether the event's `is_closure` field is true.  Closures
 * are determined by the event having a traffic impact the entails a closure.
 *
 * `status` matches the event status for 'Active' and 'Inactive', unless the
 * event was made inactive within a time window (e.g., 15 minutes), at which
 * point its state is 'cleared'.
 *
 * `state` is a frontend property determined by the pointer.  For map icons,
 * three are retrieved (one for each state); if none is specified, Static is
 * returned.
 *
 * For chainups and road conditions, severity, tense and closure are removed.
 */

function tc (text) {
  return text[0].toUpperCase() + text.substr(1);
}

function generateIconDictionary() {
  const types = ['incident', 'planned', 'chainup', 'roadcondition'];
  const severities = ['major', 'minor'];
  const tenses = ['present', 'future'];
  const closures = ['open', 'closure'];
  const statuses = ['active', 'clearing', 'inactive'];
  const states = ['static', 'hover', 'active'];

  const icons = {};
  let current;
  for (const type of types) {
    icons[type] = {};
    current = icons[type];

    for (const severity of severities) {
      const parent = current;

      if (!['chainup', 'roadcondition'].includes(type)) {
        current[severity] = {};
        current = current[severity];
      }

      for (let tense of tenses) {
        const parent = current;

        if (!['chainup', 'roadcondition'].includes(type)) {
          current[tense] = {};
          current = current[tense];
        }

        for (const closure of closures) {
          const parent = current;

          if (!['chainup', 'roadcondition'].includes(type)) {
            current[closure] = {};
            current = current[closure];
          }

          for (const status of statuses) {
            const parent = current;
            current[status] = {}
            current = current[status];

            for (const state of states) {
              const path = [type]; // path will be the name of the icon

              // chainups and road conditions skip these steps
              if (['incident', 'planned'].includes(type)) {
                path.push(tc(severity));
                if (tense === 'future') {
                  if (type === 'planned') {
                    path.push(tc(tense));
                  }
                }
                if (closure === 'closure') { path.push(tc(closure)); }
              }
              path.push(tc(status), tc(state));
              current[state] = path.join('');
            }
            current = parent;
          }
          current = parent;
        }
        current = parent;
      }
      current = parent;
    }
  }
  return JSON.stringify(icons).replaceAll('"', '');
}
globalThis.generateIconDictionary = generateIconDictionary;

const icons = {
  incident: {
    major: {
      present: {
        open: {
          active: {
            static: incidentMajorActiveStatic,
            hover: incidentMajorActiveHover,
            active: incidentMajorActiveActive,
          },
          clearing: {
            static: incidentMajorClearingStatic,
            hover: incidentMajorClearingHover,
            active: incidentMajorClearingActive,
          },
          inactive: {
            static: incidentMajorInactiveStatic,
            hover: incidentMajorInactiveHover,
            active: incidentMajorInactiveActive,
          },
        },
        closure: {
          active: {
            static: incidentMajorClosureActiveStatic,
            hover: incidentMajorClosureActiveHover,
            active: incidentMajorClosureActiveActive,
          },
          clearing: {
            static: incidentMajorClosureClearingStatic,
            hover: incidentMajorClosureClearingHover,
            active: incidentMajorClosureClearingActive,
          },
          inactive: {
            static: incidentMajorClosureInactiveStatic,
            hover: incidentMajorClosureInactiveHover,
            active: incidentMajorClosureInactiveActive,
          },
        },
      },
    },
    minor: {
      present: {
        open: {
          active: {
            static: incidentMinorActiveStatic,
            hover: incidentMinorActiveHover,
            active: incidentMinorActiveActive,
          },
          clearing: {
            static: incidentMinorClearingStatic,
            hover: incidentMinorClearingHover,
            active: incidentMinorClearingActive,
          },
          inactive: {
            static: incidentMinorInactiveStatic,
            hover: incidentMinorInactiveHover,
            active: incidentMinorInactiveActive,
          },
        },
        closure: {
          active: {
            static: incidentMinorClosureActiveStatic,
            hover: incidentMinorClosureActiveHover,
            active: incidentMinorClosureActiveActive,
          },
          clearing: {
            static: incidentMinorClosureClearingStatic,
            hover: incidentMinorClosureClearingHover,
            active: incidentMinorClosureClearingActive,
          },
          inactive: {
            static: incidentMinorClosureInactiveStatic,
            hover: incidentMinorClosureInactiveHover,
            active: incidentMinorClosureInactiveActive,
          },
        },
      },
    },
  },
  planned: {
    major: {
      present: {
        open: {
          active: {
            static: plannedMajorActiveStatic,
            hover: plannedMajorActiveHover,
            active: plannedMajorActiveActive,
          },
          clearing: {
            static: plannedMajorClearingStatic,
            hover: plannedMajorClearingHover,
            active: plannedMajorClearingActive,
          },
          inactive: {
            static: plannedMajorInactiveStatic,
            hover: plannedMajorInactiveHover,
            active: plannedMajorInactiveActive,
          },
        },
        closure: {
          active: {
            static: plannedMajorClosureActiveStatic,
            hover: plannedMajorClosureActiveHover,
            active: plannedMajorClosureActiveActive,
          },
          clearing: {
            static: plannedMajorClosureClearingStatic,
            hover: plannedMajorClosureClearingHover,
            active: plannedMajorClosureClearingActive,
          },
          inactive: {
            static: plannedMajorClosureInactiveStatic,
            hover: plannedMajorClosureInactiveHover,
            active: plannedMajorClosureInactiveActive,
          },
        },
      },
      future: {
        open: {
          active: {
            static: plannedMajorFutureActiveStatic,
            hover: plannedMajorFutureActiveHover,
            active: plannedMajorFutureActiveActive,
          },
          clearing: {
            static: plannedMajorFutureClearingStatic,
            hover: plannedMajorFutureClearingHover,
            active: plannedMajorFutureClearingActive,
          },
          inactive: {
            static: plannedMajorFutureInactiveStatic,
            hover: plannedMajorFutureInactiveHover,
            active: plannedMajorFutureInactiveActive,
          },
        },
        closure: {
          active: {
            static: plannedMajorFutureClosureActiveStatic,
            hover: plannedMajorFutureClosureActiveHover,
            active: plannedMajorFutureClosureActiveActive,
          },
          clearing: {
            static: plannedMajorFutureClosureClearingStatic,
            hover: plannedMajorFutureClosureClearingHover,
            active: plannedMajorFutureClosureClearingActive,
          },
          inactive: {
            static: plannedMajorFutureClosureInactiveStatic,
            hover: plannedMajorFutureClosureInactiveHover,
            active: plannedMajorFutureClosureInactiveActive,
          },
        },
      },
    },
    minor: {
      present: {
        open: {
          active: {
            static: plannedMinorActiveStatic,
            hover: plannedMinorActiveHover,
            active: plannedMinorActiveActive,
          },
          clearing: {
            static: plannedMinorClearingStatic,
            hover: plannedMinorClearingHover,
            active: plannedMinorClearingActive,
          },
          inactive: {
            static: plannedMinorInactiveStatic,
            hover: plannedMinorInactiveHover,
            active: plannedMinorInactiveActive,
          },
        },
        closure: {
          active: {
            static: plannedMinorClosureActiveStatic,
            hover: plannedMinorClosureActiveHover,
            active: plannedMinorClosureActiveActive,
          },
          clearing: {
            static: plannedMinorClosureClearingStatic,
            hover: plannedMinorClosureClearingHover,
            active: plannedMinorClosureClearingActive,
          },
          inactive: {
            static: plannedMinorClosureInactiveStatic,
            hover: plannedMinorClosureInactiveHover,
            active: plannedMinorClosureInactiveActive,
          },
        },
      },
      future: {
        open: {
          active: {
            static: plannedMinorFutureActiveStatic,
            hover: plannedMinorFutureActiveHover,
            active: plannedMinorFutureActiveActive,
          },
          clearing: {
            static: plannedMinorFutureClearingStatic,
            hover: plannedMinorFutureClearingHover,
            active: plannedMinorFutureClearingActive,
          },
          inactive: {
            static: plannedMinorFutureInactiveStatic,
            hover: plannedMinorFutureInactiveHover,
            active: plannedMinorFutureInactiveActive,
          },
        },
        closure: {
          active: {
            static: plannedMinorFutureClosureActiveStatic,
            hover: plannedMinorFutureClosureActiveHover,
            active: plannedMinorFutureClosureActiveActive,
          },
          clearing: {
            static: plannedMinorFutureClosureClearingStatic,
            hover: plannedMinorFutureClosureClearingHover,
            active: plannedMinorFutureClosureClearingActive,
          },
          inactive: {
            static: plannedMinorFutureClosureInactiveStatic,
            hover: plannedMinorFutureClosureInactiveHover,
            active: plannedMinorFutureClosureInactiveActive,
          },
        },
      },
    },
  },
  chainup: {
    active: {
      static: chainupActiveStatic,
      hover: chainupActiveHover,
      active: chainupActiveActive,
    },
    clearing: {
      static: chainupClearingStatic,
      hover: chainupClearingHover,
      active: chainupClearingActive,
    },
    inactive: {
      static: chainupInactiveStatic,
      hover: chainupInactiveHover,
      active: chainupInactiveActive,
    },
  },
  roadcondition: {
    active: {
      static: roadconditionActiveStatic,
      hover: roadconditionActiveHover,
      active: roadconditionActiveActive,
    },
    clearing: {
      static: roadconditionClearingStatic,
      hover: roadconditionClearingHover,
      active: roadconditionClearingActive,
    },
    inactive: {
      static: roadconditionInactiveStatic,
      hover: roadconditionInactiveHover,
      active: roadconditionInactiveActive,
    },
  },
};
globalThis.icons = icons;
export default icons;

let curr, prev;
['incident', 'planned'].forEach((type) => {
  const prev = curr;
  curr = icons[type];
  ['major', 'minor'].forEach((severity) => {
    const prev = curr;
    curr = curr[severity];
    ['present', 'future'].forEach((tense) => {
      const prev = curr;
      if (!curr[tense]) { return; }
      curr = curr[tense];
      ['open', 'closure'].forEach((closure)=> {
        if (!curr) { // incident-major has no future events
          return;
        }

        const prev = curr;
        curr = curr[closure];
        curr.pending = structuredClone(curr.active);
        ['active', 'hover', 'static'].forEach((state) => {
          curr.pending[state] = curr.pending[state].replaceAll('white', '%23D8EAFD');
          curr.pending[state] = curr.pending[state].replaceAll('%23584215', '%231E5189');
          curr.pending[state] = curr.pending[state].replaceAll('%23FACC75', '%235595D9');
          curr.pending[state] = curr.pending[state].replaceAll('%23FCBA19', '%235595D9');

          curr.pending[state] = curr.pending[state].replaceAll('%23EFB4BA', 'white');
          curr.pending[state] = curr.pending[state].replaceAll('%23CE3E39', '%235595D9');
          curr.pending[state] = curr.pending[state].replaceAll('%23953734', '%233470B1');
        });
        curr = prev;
      });
      curr = prev;
    });
    curr = prev;
  });
  curr = prev;
});

export function getPlainIcon(event, state='static') {
  return getIcon(event, state, false);
}

export function getIcon(event, state='static', includePending=true) {
  let type, status, severity, tense, closure;
  try {
    type = event.type.toLowerCase() || 'incident';
    if (type === 'planned event') { type = 'planned' ; }
    status = event.status.toLowerCase() || 'active';
    if (event.approved === false && includePending) { status = 'pending'; }

    if (['incident', 'planned'].includes(type)) {
      severity = event.details.severity.toLowerCase() || 'minor';

      if (status === 'inactive') { // TODO: cleared determine by time of last inactivation
        const lastUpdated = new Date(event.last_updated);
        if (!event.approved || lastUpdated > Date.now() - 60000 * 15) {  // TODO: time window move to env variable
          status = 'clearing';
        }
      }

      // TOOD: determine future tense once schedules are implemented
      tense = type === 'incident' ? 'present' : 'future';
      closure = event.is_closure ? 'closure' : 'open';
      return icons[type][severity][tense][closure][status][state];
    } else {
      return icons[type][status][state];
    }
  } catch (err) {
    console.log(err);
    console.log(type, severity, tense, closure, status, state);
    console.log(event);
  }
}
